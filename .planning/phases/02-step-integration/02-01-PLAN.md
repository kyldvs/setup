---
phase: 02-step-integration
plan: 01
type: execute
---

<objective>
Create a wrapper function that checks state before running steps and records completion.

Purpose: Enable fast no-op execution by checking JSON state before running each setup step, and automatically recording completion status. This is the bridge between the state management system from Phase 1 and the existing justfile recipes.
Output: A reusable `run_step` function in `lib/state.sh` that can be called from justfile recipes, plus verification with a single test recipe.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@tasks/setup/justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/state.sh with run_step wrapper function</name>
  <files>lib/state.sh</files>
  <action>Create a new bash script library with the `run_step` function. Function signature: `run_step(step_id, description, kind, subtype, command)`. Implementation flow:

1. Initialize state file if it doesn't exist (using jq to create empty JSON structure: `{"steps":{}}`)
2. Check if step is already complete by querying `$KYLDVS_PREFIX/state.json` with jq: `.steps[step_id].status == "complete"`
3. If complete: echo "[skip] $description" and return 0
4. If not complete: run the provided command, capture exit code
5. If command succeeds (exit 0): record step completion in state.json with jq: `.steps[step_id] = {id, description, kind, subtype, status: "complete", completed_at: ISO8601 timestamp}`
6. Return the command's exit code

Use `set -euo pipefail` at the top. Use `jq` for all JSON operations. State file path should be `$KYLDVS_PREFIX/state.json` (with default fallback to `$HOME/.kyldvs/state.json` if `$KYLDVS_PREFIX` not set). Include error handling for jq failures. Use `date -u +"%Y-%m-%dT%H:%M:%SZ"` for ISO8601 timestamps.</action>
  <verify>Source the file with `source lib/state.sh`, then run `run_step "test-001" "Test step" "automated" "other" "echo 'hello'"` twice - first run should execute and print "hello", second run should print "[skip] Test step"</verify>
  <done>Function exists, can be sourced without errors, properly checks state, skips completed steps with skip message, records new completions with all required fields</done>
</task>

<task type="auto">
  <name>Task 2: Add skip message output formatting</name>
  <files>lib/state.sh</files>
  <action>Enhance the skip message output in the `run_step` function to be consistent and visible. When a step is skipped, print: `echo "[skip] $description"` in a light gray color using ANSI codes (if terminal supports color, check with `[ -t 1 ]`). Use `\033[90m` for gray and `\033[0m` to reset. Keep the non-colored fallback for non-TTY output. Ensure the skip message always prints to stdout (not stderr).</action>
  <verify>Run `run_step "test-002" "Second test" "automated" "other" "true"` twice. Second run should show gray "[skip] Second test" message when running in a terminal</verify>
  <done>Skip messages are clearly visible, consistently formatted, use color in terminals, work without color in non-TTY contexts</done>
</task>

<task type="auto">
  <name>Task 3: Test wrapper with single justfile recipe</name>
  <files>tasks/setup/justfile</files>
  <action>Modify the `rust` recipe in tasks/setup/justfile to use the new `run_step` wrapper as a proof of concept. The recipe currently checks if rustup is installed and either skips or runs the curl installer. Convert this to use `run_step`:

1. Source the state library at the top of the recipe: `source ./lib/state.sh`
2. Replace the entire rustup installation logic with: `run_step "setup-rust-rustup" "Install Rust via rustup" "automated" "other" "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"`
3. Keep the existing `set -euo pipefail`

This demonstrates the wrapper working with an idempotent recipe - first run installs, subsequent runs skip.</action>
  <verify>Run `just setup rust` twice from the repository root. First run should execute the curl installer (or skip if already installed), second run should print "[skip] Install Rust via rustup" without running curl</verify>
  <done>Rust recipe uses run_step wrapper, first execution runs installer, subsequent executions skip with visible message, no changes to behavior when rustup is not installed</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `source lib/state.sh` loads without errors
- [ ] Running `run_step` twice on same step shows skip behavior
- [ ] State file `$KYLDVS_PREFIX/state.json` or `$HOME/.kyldvs/state.json` is created with valid JSON
- [ ] `jq . < $HOME/.kyldvs/state.json` shows recorded steps with all fields
- [ ] `just setup rust` command is idempotent (second run skips)
- [ ] Skip messages are visible and clearly formatted
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No bash syntax errors in lib/state.sh
- State file contains valid JSON with step records
- Wrapper function is reusable and can be called from any justfile recipe
- Skip behavior works correctly (reads state, skips execution, shows message)
- Record behavior works correctly (executes command, writes state on success)
</success_criteria>

<output>
After completion, create `.planning/phases/02-step-integration/02-01-SUMMARY.md`:

# Phase 2 Plan 1: Step Wrapper Function Summary

**[One-liner summary of what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `lib/state.sh` - Description
- `tasks/setup/justfile` - Description

## Decisions Made
[Any technical decisions, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 02-02-PLAN.md (Convert remaining justfile recipes to use wrapper)
</output>
