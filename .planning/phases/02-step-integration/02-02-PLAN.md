---
phase: 02-step-integration
plan: 02
type: execute
---

<objective>
Convert 8 existing setup recipes to use run_step wrapper with automated state tracking.

Purpose: Transform existing justfile recipes (brew, home, brew-services, docker, mac-dock, mac-defaults, nvm, rust) to check state before running and record completion. Arc recipe remains manual and will be handled in Phase 3.

Output: All 8 recipes wrapped with run_step calls using appropriate kind (automated) and subtype classifications (brew, brew-cask, mac-defaults, other).
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@tasks/setup/justfile
@lib/state.sh
</context>

<tasks>

<task id="1" type="auto">
<action>Convert brew, home, and brew-services recipes to use run_step wrapper</action>

<details>
Update tasks/setup/justfile:

**brew recipe:**
- Wrap with: `run_step "brew-install" "Install brew packages and casks" "automated" "brew-cask"`
- Explanation: This recipe includes both brew casks (--cask) and regular brew packages, so use brew-cask subtype to capture both
- Keep existing implementation (all the brew install commands)

**home recipe:**
- Wrap with: `run_step "home-dotfiles" "Link dotfiles using stow" "automated" "other"`
- Explanation: Dotfile symlinking doesn't fit brew/mac-defaults categories
- Keep existing stow command

**brew-services recipe:**
- Wrap with: `run_step "brew-services" "Start brew services" "automated" "brew"`
- Explanation: Uses brew services command, appropriate for brew subtype
- Keep existing brew services start commands
</details>

<verification>
```bash
# Verify recipes have run_step wrapper calls
grep -A 3 "^brew:" tasks/setup/justfile | grep -q "run_step.*brew-install"
grep -A 3 "^home:" tasks/setup/justfile | grep -q "run_step.*home-dotfiles"
grep -A 3 "^brew-services:" tasks/setup/justfile | grep -q "run_step.*brew-services"

# Verify recipes still execute properly (will skip if already done)
just setup brew
just setup home
just setup brew-services
```
</verification>

<done>
- brew recipe wrapped with run_step using brew-cask subtype
- home recipe wrapped with run_step using other subtype
- brew-services recipe wrapped with run_step using brew subtype
- All recipes execute without errors
</done>
</task>

<task id="2" type="auto">
<action>Convert docker, mac-dock, and mac-defaults recipes to use run_step wrapper</action>

<details>
Update tasks/setup/justfile:

**docker recipe:**
- Wrap with: `run_step "docker-desktop" "Install Docker Desktop" "automated" "brew-cask"`
- Explanation: Installs .dmg application, similar to brew cask behavior
- Keep existing download and install logic

**mac-dock recipe:**
- Wrap with: `run_step "mac-dock" "Configure macOS dock" "automated" "mac-defaults"`
- Explanation: Uses dockutil which modifies dock preferences (similar to defaults command)
- Keep existing dockutil commands and try_remove_dock_item function

**mac-defaults recipe:**
- Wrap with: `run_step "mac-defaults" "Set macOS system defaults" "automated" "mac-defaults"`
- Explanation: Uses defaults write commands
- Keep existing ensure_defaults function and all defaults write calls
</details>

<verification>
```bash
# Verify recipes have run_step wrapper calls
grep -A 3 "^docker:" tasks/setup/justfile | grep -q "run_step.*docker-desktop"
grep -A 3 "^mac-dock:" tasks/setup/justfile | grep -q "run_step.*mac-dock"
grep -A 3 "^mac-defaults:" tasks/setup/justfile | grep -q "run_step.*mac-defaults"

# Verify recipes still execute properly
just setup docker
just setup mac-dock
just setup mac-defaults
```
</verification>

<done>
- docker recipe wrapped with run_step using brew-cask subtype
- mac-dock recipe wrapped with run_step using mac-defaults subtype
- mac-defaults recipe wrapped with run_step using mac-defaults subtype
- All recipes execute without errors
</done>
</task>

<task id="3" type="auto">
<action>Convert nvm and rust recipes to use run_step wrapper</action>

<details>
Update tasks/setup/justfile:

**nvm recipe:**
- Wrap with: `run_step "nvm" "Install Node Version Manager" "automated" "other"`
- Explanation: Custom curl installer, doesn't fit brew/mac-defaults categories
- Keep existing nvm install script and check

**rust recipe:**
- Wrap with: `run_step "rust" "Install Rust via rustup" "automated" "other"`
- Explanation: Custom curl installer (rustup), doesn't fit brew/mac-defaults categories
- Keep existing rustup install script and check
</details>

<verification>
```bash
# Verify recipes have run_step wrapper calls
grep -A 3 "^nvm:" tasks/setup/justfile | grep -q "run_step.*nvm"
grep -A 3 "^rust:" tasks/setup/justfile | grep -q "run_step.*rust"

# Verify recipes still execute properly
just setup nvm
just setup rust

# Verify arc recipe remains unchanged (manual step, handled in Phase 3)
grep -A 2 "^arc:" tasks/setup/justfile | grep -qv "run_step"
```
</verification>

<done>
- nvm recipe wrapped with run_step using other subtype
- rust recipe wrapped with run_step using other subtype
- arc recipe remains untouched (manual, Phase 3)
- All recipes execute without errors
</done>
</task>

<task id="4" type="auto">
<action>Run full setup to verify state tracking works end-to-end</action>

<details>
Execute `just setup all` and verify:

1. State file is created at $KYLDVS_PREFIX/state.json
2. Each recipe that was already completed shows `[skip] <description>` message
3. State file contains entries for all 8 converted recipes with status "complete"
4. Arc recipe runs without state tracking (not yet converted)

Check state file contents:
```bash
cat "$KYLDVS_PREFIX/state.json" | jq .
```

Expected structure:
```json
{
  "brew-install": {
    "id": "brew-install",
    "description": "Install brew packages and casks",
    "kind": "automated",
    "subtype": "brew-cask",
    "status": "complete",
    "completed_at": "2025-11-24T..."
  },
  "home-dotfiles": { ... },
  ...
}
```
</details>

<verification>
```bash
# Verify state file exists
test -f "$KYLDVS_PREFIX/state.json"

# Verify all 8 steps are in state file
jq -r 'keys[]' "$KYLDVS_PREFIX/state.json" | sort | diff - <(echo -e "brew-install\nbrew-services\ndocker-desktop\nhome-dotfiles\nmac-defaults\nmac-dock\nnvm\nrust")

# Verify all steps are marked complete
test $(jq '[.[] | select(.status == "complete")] | length' "$KYLDVS_PREFIX/state.json") -eq 8

# Run setup again - should skip all 8 converted steps
just setup all 2>&1 | grep -c "\[skip\]" | grep -q "8"
```
</verification>

<done>
- State file created with all 8 steps
- Each step has correct id, description, kind, subtype, and status
- Re-running setup skips completed steps with clear messages
- State tracking working end-to-end
</done>
</task>

</tasks>

<verification>
Final checks before creating SUMMARY:

```bash
# All recipes use run_step except arc
grep -c "run_step" tasks/setup/justfile | grep -q "8"

# State file has exactly 8 entries (arc not included)
jq 'keys | length' "$KYLDVS_PREFIX/state.json" | grep -q "8"

# All steps marked complete
jq '[.[] | select(.status == "complete")] | length' "$KYLDVS_PREFIX/state.json" | grep -q "8"

# Running setup all is fast (no-op)
time just setup all  # Should complete in < 5 seconds with 8 skip messages
```
</verification>

<success_criteria>
- 8 recipes converted: brew, home, brew-services, docker, mac-dock, mac-defaults, nvm, rust
- Each uses appropriate subtype:
  - brew → brew-cask (includes casks and regular packages)
  - home → other
  - brew-services → brew
  - docker → brew-cask (dmg install)
  - mac-dock → mac-defaults (dock preferences)
  - mac-defaults → mac-defaults
  - nvm → other (curl installer)
  - rust → other (curl installer)
- Arc recipe unchanged (manual, Phase 3)
- State tracking works: completed steps show [skip] on re-run
- `just setup all` is fast no-op when everything complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-step-integration/02-02-SUMMARY.md` documenting:
- All 8 recipes converted with appropriate subtypes
- State tracking verified working end-to-end
- Files modified (tasks/setup/justfile)
- Any deviations or issues encountered
- Ready for Phase 3 (manual step handling for arc recipe)
</output>
