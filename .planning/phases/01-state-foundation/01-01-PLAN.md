---
phase: 01-state-foundation
plan: 01
type: execute
---

<objective>
Create core JSON state file management utilities using jq to enable persistent tracking of setup step completion status.

Purpose: Provide foundational shell library functions for initializing, reading, and writing JSON state at `$KYLDVS_PREFIX/state.json`. This enables the setup system to remember what's been done, making re-runs fast and enabling future undo capabilities.

Output:
- `lib/state.sh` - Shell library with state management functions
- jq installed via bootstrap.sh
- State file initialization in justfile
- Working state persistence at `/usr/local/kyldvs/state.json` (macOS)
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@bootstrap.sh
@tasks/setup/justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/state.sh with core jq-based state functions</name>
  <files>/Users/kad/kyldvs/setup/lib/state.sh</files>
  <action>
Create shell script library at `lib/state.sh` with the following functions:

1. `state_init()` - Initialize empty state file with JSON structure if it doesn't exist
   - Check if `$KYLDVS_PREFIX/state.json` exists
   - If not, create with structure: `{"version": "1.0.0", "steps": {}}`
   - Ensure proper permissions and directory exists
   - Return success/failure status

2. `state_read()` - Read entire state file and output to stdout
   - Verify state file exists, call state_init if not
   - Use jq to format and output JSON
   - Handle errors gracefully

3. `state_write(json)` - Write entire JSON state (passed as arg) to state file
   - Accept JSON string as parameter
   - Validate JSON with jq before writing
   - Write atomically using temp file + mv
   - Return success/failure status

4. `state_get(key)` - Get value for specific key from state using jq path syntax
   - Accept jq path as parameter (e.g., ".steps.brew_install.status")
   - Query state file with jq
   - Return value to stdout, empty if not found

5. `state_set(key, value)` - Set value for specific key using jq
   - Accept jq path and value as parameters
   - Read current state, update with jq, write back atomically
   - Support both string and JSON values
   - Return success/failure status

Implementation requirements:
- Use `set -euo pipefail` for safety
- All functions should work with KYLDVS_PREFIX variable
- Add error handling with informative messages
- Include usage comments for each function
- Source-able library (no execution on load)
  </action>
  <verify>
- Run `bash -n lib/state.sh` to check syntax
- Source the file: `source lib/state.sh`
- Test state_init creates valid JSON file
- Test state_get/state_set roundtrip
- Verify atomic writes (no corruption on interrupt)
  </verify>
  <done>
- lib/state.sh exists and passes shellcheck
- All 5 functions implemented and tested
- Functions handle errors gracefully
- State file uses atomic writes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add jq installation to bootstrap.sh</name>
  <files>/Users/kad/kyldvs/setup/bootstrap.sh</files>
  <action>
Add jq installation alongside the existing just installation in bootstrap.sh.

Locate the section that installs just (around line 836-840):
```bash
if ! command -v just >/dev/null
then
  ohai "Installing Just..."
  brew install just
fi
```

Add similar check for jq immediately after:
```bash
if ! command -v jq >/dev/null
then
  ohai "Installing jq..."
  brew install jq
fi
```

This ensures jq is available before any setup commands that depend on state.sh are run.
  </action>
  <verify>
- Read bootstrap.sh to confirm jq installation added
- Verify it follows same pattern as just installation
- Check `command -v jq` test is used (not `which`)
- Confirm brew install jq is used
  </verify>
  <done>
- jq installation check added to bootstrap.sh
- Follows existing code style and patterns
- Will install jq via Homebrew if not present
  </done>
</task>

<task type="auto">
  <name>Task 3: Add state initialization to justfile</name>
  <files>/Users/kad/kyldvs/setup/tasks/setup/justfile</files>
  <action>
Add a new state initialization recipe to the setup justfile that will be called before any setup tasks run.

Add a new recipe `init-state` at the top of the tasks section (after line 7, before `all:`):

```just
# Initialize state file for tracking setup progress
init-state:
  #!/usr/bin/env bash
  set -euo pipefail

  # Set KYLDVS_PREFIX based on OS (matches bootstrap.sh logic)
  if [[ "$(uname)" == "Darwin" ]]; then
    export KYLDVS_PREFIX="/usr/local/kyldvs"
  else
    export KYLDVS_PREFIX="/home/kyldvs"
  fi

  # Source state library
  source "$(dirname "${BASH_SOURCE[0]}")/../../lib/state.sh"

  # Initialize state file
  state_init
  echo "State file initialized at $KYLDVS_PREFIX/state.json"
```

Then update the `all` recipe to call `init-state` first:

```just
all:
  just setup init-state
  just setup brew
  just setup home
  # ... rest of existing calls
```

This ensures the state file exists before any setup step tries to use it.
  </action>
  <verify>
- Run `just setup init-state` to test initialization
- Verify state file created at correct location
- Check state file contains valid JSON with version and steps fields
- Confirm `just setup all` calls init-state first
  </verify>
  <done>
- init-state recipe added to justfile
- Recipe properly sources lib/state.sh
- Sets KYLDVS_PREFIX correctly for macOS/Linux
- all recipe calls init-state first
- State file successfully created when run
  </done>
</task>

<task type="auto">
  <name>Task 4: Create lib directory and .gitkeep</name>
  <files>/Users/kad/kyldvs/setup/lib/.gitkeep</files>
  <action>
Create the lib directory structure and ensure it's tracked in git.

```bash
mkdir -p lib
touch lib/.gitkeep
```

This ensures the lib directory exists in the repository before state.sh is created in Task 1.
  </action>
  <verify>
- Directory lib/ exists
- File lib/.gitkeep exists
- Can create files in lib/
  </verify>
  <done>
- lib/ directory created
- lib/.gitkeep exists for git tracking
  </done>
</task>

</tasks>

<verification>
Manual verification steps after all tasks complete:

1. **State Library Functions**
   ```bash
   source lib/state.sh
   export KYLDVS_PREFIX="/tmp/test-state"
   mkdir -p "$KYLDVS_PREFIX"

   # Test init
   state_init
   cat "$KYLDVS_PREFIX/state.json"  # Should show {"version":"1.0.0","steps":{}}

   # Test set
   state_set ".steps.test_step.status" "completed"

   # Test get
   state_get ".steps.test_step.status"  # Should output: completed

   # Test read
   state_read  # Should show full JSON with test_step

   # Cleanup
   rm -rf /tmp/test-state
   ```

2. **Bootstrap Integration**
   ```bash
   # Check jq installed (or will be by bootstrap)
   command -v jq
   grep "jq" bootstrap.sh  # Should find jq installation section
   ```

3. **Justfile Integration**
   ```bash
   # Test state initialization via justfile
   just setup init-state

   # Verify state file exists with correct structure
   cat /usr/local/kyldvs/state.json
   jq '.version' /usr/local/kyldvs/state.json  # Should output: "1.0.0"
   jq '.steps' /usr/local/kyldvs/state.json    # Should output: {}
   ```

4. **Error Handling**
   ```bash
   # Test invalid JSON rejection
   source lib/state.sh
   export KYLDVS_PREFIX="/tmp/test-state"
   mkdir -p "$KYLDVS_PREFIX"
   state_init

   # This should fail gracefully
   echo "invalid json" > "$KYLDVS_PREFIX/state.json"
   state_read  # Should show error, not crash
   ```

All functions should work correctly and handle edge cases gracefully.
</verification>

<success_criteria>
1. lib/state.sh exists with all 5 required functions (state_init, state_read, state_write, state_get, state_set)
2. All functions use jq correctly for JSON operations
3. State writes are atomic (temp file + mv pattern)
4. bootstrap.sh installs jq via Homebrew
5. justfile has init-state recipe that successfully creates state file
6. `just setup all` calls init-state before other tasks
7. State file created at `$KYLDVS_PREFIX/state.json` with structure: `{"version":"1.0.0","steps":{}}`
8. All shell scripts pass shellcheck
9. Functions handle missing files, invalid JSON, and other errors gracefully
10. Manual verification steps all pass successfully
</success_criteria>

<output>
After completion, create `.planning/phases/01-state-foundation/01-01-SUMMARY.md` using the summary template. Include:
- What was built (state library functions)
- Key decisions (jq-based, atomic writes, KYLDVS_PREFIX variable)
- Files created/modified
- Verification results
- Any issues encountered
- Readiness for next plan (01-02: Step data model)
</output>
