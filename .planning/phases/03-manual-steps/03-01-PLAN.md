---
phase: 03-manual-steps
plan: 01
type: execute
---

<objective>
Implement user prompting and confirmation workflow for manual setup steps that require human action.

Purpose: Convert manual steps (like Arc browser configuration) from comments to interactive prompts that record completion status in state.json, enabling fast skips on re-runs and clear tracking of what's been done.

Output:
- `lib/manual.sh` - Manual step prompting functions
- Updated `tasks/setup/justfile` - Arc recipe converted to use manual step function
- State tracking for manual step completion
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@tasks/setup/justfile
@bootstrap.sh
</context>

<tasks>

<task id="1" type="auto">
<action>Create lib/manual.sh with run_manual_step function</action>

<details>
Create `/Users/kad/kyldvs/setup/lib/manual.sh` with the following functionality:

```bash
#!/usr/bin/env bash
# Manual step prompting and state tracking

# run_manual_step <step_id> <description> <instructions...>
#
# Prompts user to complete manual steps, records completion in state.json
#
# Args:
#   step_id: Unique identifier for this manual step (e.g., "arc-login")
#   description: Brief description shown in skip message
#   instructions: One or more lines of instructions to display
#
# Behavior:
#   - If already complete: print "[skip] <description>" and return
#   - If not complete: display instructions, prompt for confirmation
#   - On "y": record completion in state.json
#   - On "n": exit without recording completion
#   - On "s": skip without recording (allows re-prompt next time)
#
# State format in state.json:
#   "steps": {
#     "arc-login": {
#       "kind": "manual",
#       "status": "complete",
#       "description": "Arc browser login",
#       "completed_at": "2025-11-24T23:45:00Z"
#     }
#   }
```

The function should:
1. Source state management utilities (will need to check if lib/state.sh exists)
2. Check if step is already complete using state query
3. If complete: print skip message and return 0
4. If not complete:
   - Print a clear header (e.g., "=== Manual Step Required ===")
   - Display the description
   - Display each instruction line
   - Prompt: "Complete these steps, then: (y)es to confirm, (n)o to exit, (s)kip for now"
   - Read user input
   - Handle y/n/s responses
5. On "y": record step completion with timestamp
6. On "n": exit 1
7. On "s": return 0 without recording

Use `jq` for JSON state management (already installed per bootstrap.sh).
</details>

<verification>
- File `/Users/kad/kyldvs/setup/lib/manual.sh` exists
- Function `run_manual_step` is defined
- Function sources or implements state checking
- Function handles y/n/s user responses
- Uses jq for state.json updates
</verification>

<done>
Manual step function implemented with state tracking and user prompting
</done>
</task>

<task id="2" type="auto">
<action>Determine state management approach</action>

<details>
Since Phase 1 and Phase 2 may not be complete yet, we need to handle state management. Check if `lib/state.sh` exists from previous phases.

**If lib/state.sh exists:**
- Source it in lib/manual.sh
- Use its state management functions

**If lib/state.sh does NOT exist:**
- Implement basic state management inline in lib/manual.sh
- Create simple functions:
  - `state_file()` - returns path to state.json (e.g., `$HOME/.kyldvs/state.json`)
  - `state_init()` - creates empty state.json if it doesn't exist
  - `state_check_step()` - checks if step is complete
  - `state_record_step()` - records step completion

Keep it minimal but functional. The goal is to make manual steps work even if Phase 1/2 aren't complete yet.

State file location: `$HOME/.kyldvs/state.json`
Create parent directory if needed: `mkdir -p "$HOME/.kyldvs"`

Initial state structure:
```json
{
  "version": "1.0",
  "steps": {}
}
```
</details>

<verification>
- State management functions are available in lib/manual.sh
- Can query step completion status
- Can record step completion with timestamp
- Creates state file and directory if needed
</verification>

<done>
State management integrated into manual step function
</done>
</task>

<task id="3" type="auto">
<action>Convert arc recipe to use run_manual_step</action>

<details>
Update the `arc` recipe in `/Users/kad/kyldvs/setup/tasks/setup/justfile` to use the new manual step function.

Current arc recipe (lines 181-195) has manual steps as comments. Convert to:

```bash
arc:
  #!/usr/bin/env bash
  set -euo pipefail

  # Source manual step function
  source "$KYLDVS_REPO/lib/manual.sh"

  run_manual_step "arc-login" "Arc browser login" \
    "1. Open Arc browser" \
    "2. Click on profile icon" \
    "3. Select 'Login' and complete authentication"

  run_manual_step "arc-sync-sidebar" "Sync Arc sidebar" \
    "1. Open Arc Settings" \
    "2. Navigate to: Kyle -> Sync sidebar" \
    "3. Enable sidebar sync"

  run_manual_step "arc-profiles" "Configure Arc profiles" \
    "1. Settings -> Profiles -> Make: Personal, Stoke, Ragkit" \
    "2. Settings -> Profiles -> Set as Default" \
    "3. Settings -> Profiles -> Archive Tabs after 30 days" \
    "4. Settings -> Profiles -> Downloads -> Ask Every Time"

  run_manual_step "arc-defaults" "Set Arc as default browser" \
    "1. Settings -> Arc -> Set as Default Browser"

  run_manual_step "arc-passwords" "Disable password saving" \
    "1. On Each Profile -> Passwords -> Settings" \
    "2. Disable 'Offer to Save Passwords'"
```

Note: The original comments list all steps together. Break them into logical groups for better UX - user completes one group, confirms, moves to next.

The $KYLDVS_REPO variable should be the repository root. If it doesn't exist, the recipe should use a relative path or define it.
</details>

<verification>
- Arc recipe sources lib/manual.sh
- Arc recipe uses run_manual_step for each manual step group
- Each step has clear description and instructions
- Recipe runs without errors
- KYLDVS_REPO or equivalent path is available
</verification>

<done>
Arc recipe converted to interactive manual step prompting
</done>
</task>

<task id="4" type="auto">
<action>Test manual step workflow</action>

<details>
Test the complete manual step workflow:

1. **First run test (nothing complete):**
   ```bash
   just setup arc
   ```
   - Should prompt for first manual step
   - Test "s" (skip) - should skip without recording
   - Should prompt for same step again on next run

2. **Completion test:**
   ```bash
   just setup arc
   ```
   - Test "y" (confirm) - should record completion
   - Check state.json has the step recorded
   - Run again - should skip that step

3. **Skip all test:**
   ```bash
   just setup arc
   ```
   - After some steps complete, verify only incomplete steps prompt
   - Complete steps should show "[skip] <description>"

4. **Exit test:**
   ```bash
   just setup arc
   ```
   - Test "n" (no/exit) - should exit with error code
   - Should not record completion

5. **State file test:**
   - Verify state.json is created at correct location
   - Verify JSON structure is valid
   - Verify timestamps are ISO 8601 format

Run these tests and verify behavior matches expectations.
</details>

<verification>
- Manual step prompts display correctly
- "y" records completion in state.json
- "n" exits without recording
- "s" skips without recording
- Completed steps show skip message on re-run
- State file is valid JSON with correct structure
- All Arc manual steps can be completed
</verification>

<done>
Manual step workflow tested and verified working
</done>
</task>

<task id="5" type="auto">
<action>Add usage documentation to lib/manual.sh</action>

<details>
Add comprehensive usage documentation at the top of lib/manual.sh:

```bash
#!/usr/bin/env bash
# Manual Step Prompting for Setup Tasks
#
# Provides interactive prompting for manual configuration steps that require
# human action, with state tracking to enable fast skips on re-runs.
#
# USAGE:
#   source "$KYLDVS_REPO/lib/manual.sh"
#   run_manual_step <step_id> <description> <instruction_lines...>
#
# EXAMPLE:
#   run_manual_step "arc-login" "Arc browser login" \
#     "1. Open Arc browser" \
#     "2. Click profile icon" \
#     "3. Complete login"
#
# BEHAVIOR:
#   - First run: Prompts user with instructions
#   - User confirms (y): Records completion, continues
#   - User exits (n): Exits script with error
#   - User skips (s): Continues without recording (will prompt again next time)
#   - Subsequent runs: Skips completed steps with message
#
# STATE:
#   Stored in: $HOME/.kyldvs/state.json
#   Format: {"steps": {"<step_id>": {"kind": "manual", "status": "complete", ...}}}
```

Also add inline comments explaining key sections of the code.
</details>

<verification>
- Documentation clearly explains usage
- Example is easy to understand
- Behavior is documented
- State format is documented
- Code has helpful inline comments
</verification>

<done>
Documentation added to manual step function
</done>
</task>

</tasks>

<verification>
## Integration Tests
- Run `just setup arc` multiple times:
  - First run: prompts for all steps
  - After confirming all: shows all skip messages
  - After partial completion: only prompts for incomplete steps
- State file at `$HOME/.kyldvs/state.json` is valid JSON
- Manual steps can be completed, skipped, or exited

## Code Quality
- lib/manual.sh is properly formatted shell script
- Functions have clear responsibilities
- Error handling for missing jq or invalid state
- User prompts are clear and helpful

## Success Criteria Met
- Manual steps prompt user and wait for confirmation
- Completion status is recorded in state.json
- Completed steps are skipped on re-run with clear message
- Arc recipe converted from comments to interactive prompts
- Works even if Phase 1/2 state utilities don't exist yet
</verification>

<success_criteria>
- `lib/manual.sh` created with run_manual_step function
- Function checks completion status before prompting
- Function prompts user with clear instructions
- Function records completion on confirmation (y)
- Function exits on rejection (n)
- Function skips without recording on skip (s)
- Arc recipe converted to use manual step function
- All Arc configuration steps work as manual steps
- State persists in `$HOME/.kyldvs/state.json`
- Re-running shows skip messages for completed steps
- Documentation explains usage and behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-manual-steps/03-01-SUMMARY.md` using the summary template at `~/.claude/skills/create-plans/templates/summary.md`.

Commit with message:
```
feat(03-01): manual step prompting with state tracking

- Interactive user prompts for Arc browser configuration
- Completion tracking in state.json enables fast skips
- Support for confirm/exit/skip workflow
```
</output>
