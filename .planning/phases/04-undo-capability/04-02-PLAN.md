---
phase: 04-undo-capability
plan: 02
type: execute
---

<objective>
Integrate undo commands into justfile and state tracking to enable users to revert completed setup steps.

Purpose: Provide user-facing commands for undoing setup operations, listing undoable steps, and tracking undo status in state.json. This completes the undo capability by connecting the undo functions (from 04-01) to the justfile interface.

Output:
- `just setup undo <step-id>` command for reverting individual steps
- `just setup undo-list` command showing reversible completed steps
- State tracking for "undone" status (status can be: pending, complete, undone)
- Updated state.sh with undo status functions
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/04-undo-capability/04-01-SUMMARY.md
@lib/state.sh
@tasks/setup/justfile
</context>

<tasks>

<task id="1" type="auto">
<action>
Add undo status tracking functions to lib/state.sh
</action>

<details>
Create functions to:
1. Mark a step as "undone" in state.json (state_mark_undone <step-id>)
2. Check if a step can be undone (state_is_undoable <step-id>)
   - Returns true if step is "complete" and has reversible subtype
3. List all undoable steps (state_list_undoable)
   - Returns step IDs with status="complete" and subtype in (brew, brew-cask, mac-defaults)

Implementation notes:
- Use jq to update status field: `jq '.steps[] | select(.id == $id) | .status = "undone"'`
- Undoable = status is "complete" AND subtype in ("brew", "brew-cask", "mac-defaults")
- List function should output: step-id, description, subtype (tab-separated for easy parsing)
</details>

<verification>
- state_mark_undone updates status to "undone" in state.json
- state_is_undoable returns 0 (true) for completed reversible steps, 1 (false) otherwise
- state_list_undoable outputs only completed steps with reversible subtypes
</verification>

<done_criteria>
- Functions added to lib/state.sh
- Manual test: echo test state with completed brew step, verify state_is_undoable returns 0
- Manual test: state_list_undoable shows only reversible completed steps
</done_criteria>
</task>

<task id="2" type="auto">
<action>
Add `undo-list` recipe to tasks/setup/justfile
</action>

<details>
Create a new recipe that:
1. Sources lib/state.sh
2. Calls state_list_undoable
3. Formats output for user display

Recipe should:
- Show "No steps available to undo" if list is empty
- Display table format:
  ```
  Step ID              Description                          Type
  ----------------------------------------------------------------
  brew-bitwarden       Install Bitwarden password manager   brew-cask
  mac-defaults-dock    Dock on left side                    mac-defaults
  ```
- Use printf for aligned columns

Example implementation:
```bash
undo-list:
  #!/usr/bin/env bash
  set -euo pipefail
  source ./lib/state.sh

  # Get undoable steps
  undoable=$(state_list_undoable)

  if [ -z "$undoable" ]; then
    echo "No steps available to undo"
    exit 0
  fi

  # Display header
  printf "%-20s %-35s %s\n" "Step ID" "Description" "Type"
  printf "%.0s-" {1..70}
  echo

  # Display steps
  echo "$undoable" | while IFS=$'\t' read -r id desc subtype; do
    printf "%-20s %-35s %s\n" "$id" "$desc" "$subtype"
  done
```
</details>

<verification>
- `just setup undo-list` runs without error
- Shows "No steps available to undo" when no completed reversible steps exist
- Shows formatted table when completed reversible steps exist
- Table columns are aligned and readable
</verification>

<done_criteria>
- Recipe added to tasks/setup/justfile
- Test: run on empty state shows "No steps available"
- Test: run with mock completed brew step shows formatted table
</done_criteria>
</task>

<task id="3" type="auto">
<action>
Add `undo` recipe to tasks/setup/justfile
</action>

<details>
Create a recipe that accepts a step-id argument and:
1. Validates step-id is provided
2. Checks step is undoable using state_is_undoable
3. Calls appropriate undo function from 04-01 based on subtype
4. Marks step as "undone" using state_mark_undone
5. Provides clear feedback to user

Recipe signature: `undo STEP_ID`

Implementation:
```bash
undo STEP_ID:
  #!/usr/bin/env bash
  set -euo pipefail
  source ./lib/state.sh
  source ./lib/undo.sh

  step_id="{{ STEP_ID }}"

  # Check if step exists and is undoable
  if ! state_is_undoable "$step_id"; then
    echo "Error: Step '$step_id' cannot be undone"
    echo "Reasons:"
    echo "  - Step may not be completed yet"
    echo "  - Step may not be reversible (only brew, brew-cask, mac-defaults can be undone)"
    echo "  - Step may already be undone"
    echo ""
    echo "Run 'just setup undo-list' to see available steps"
    exit 1
  fi

  # Get step info
  subtype=$(state_get_subtype "$step_id")
  desc=$(state_get_description "$step_id")

  echo "Undoing: $desc"
  echo "Type: $subtype"
  echo ""

  # Call appropriate undo function
  case "$subtype" in
    brew)
      undo_brew "$step_id"
      ;;
    brew-cask)
      undo_brew_cask "$step_id"
      ;;
    mac-defaults)
      undo_mac_defaults "$step_id"
      ;;
    *)
      echo "Error: Unknown subtype '$subtype'"
      exit 1
      ;;
  esac

  # Mark as undone
  state_mark_undone "$step_id"

  echo ""
  echo "✓ Step undone successfully"
  echo "Run 'just setup <step>' to re-apply"
```

Note: Will need to add state_get_subtype and state_get_description helper functions to lib/state.sh in this task.
</details>

<verification>
- `just setup undo` without argument shows error about missing STEP_ID
- `just setup undo nonexistent` shows error about step not being undoable
- `just setup undo <valid-id>` calls correct undo function based on subtype
- Step marked as "undone" in state.json after successful undo
- Clear success message displayed
- Error messages are helpful and guide user to undo-list
</verification>

<done_criteria>
- Recipe added to tasks/setup/justfile
- state_get_subtype and state_get_description added to lib/state.sh
- Test: undo without argument fails with helpful error
- Test: undo invalid step-id fails with helpful error
- Test: undo valid brew-cask step calls undo_brew_cask and marks as undone
</done_criteria>
</task>

<task id="4" type="auto">
<action>
Update main `all` recipe to skip undone steps
</action>

<details>
Modify the step execution wrapper to check for "undone" status and skip re-running undone steps until they're explicitly re-run.

Current flow:
- Check if status == "complete" → skip
- Check if status == "pending" → run

New flow:
- Check if status == "complete" → skip with "[skip] description"
- Check if status == "undone" → skip with "[undone] description - run 'just setup <step>' to re-apply"
- Check if status == "pending" → run

This ensures undone steps are treated similarly to completed steps (not re-run in `just setup all`), but with distinct messaging.

Implementation approach:
Add to step execution wrapper function (created in phase 2):
```bash
status=$(state_get_status "$step_id")

if [ "$status" = "complete" ]; then
  echo "[skip] $description"
  return 0
fi

if [ "$status" = "undone" ]; then
  echo "[undone] $description - run 'just setup $step_id' to re-apply"
  return 0
fi

# Status is "pending" - proceed with execution
# ... existing execution logic ...
```

Note: This assumes phase 2 created a step wrapper function. If not, will need to adapt the pattern to existing code structure.
</details>

<verification>
- `just setup all` skips undone steps with "[undone]" prefix
- Undone steps show helpful message about how to re-apply
- Individual step commands (`just setup <step>`) can re-run undone steps
- Re-running undone step changes status back to "complete"
</verification>

<done_criteria>
- Execution wrapper updated to handle "undone" status
- Test: setup all on state with undone step shows "[undone]" message
- Test: running individual step after undo changes status to complete
</done_criteria>
</task>

<task id="5" type="auto">
<action>
Add help text for new undo commands
</action>

<details>
Update the justfile help recipe (inherited from prelude/task/justfile) or add command documentation so users know about:
- `just setup undo <step-id>` - Undo a completed step
- `just setup undo-list` - Show steps that can be undone

If prelude/task/justfile provides auto-generated help from recipe comments, add appropriate comments:
```just
# List steps that can be undone
undo-list:
  ...

# Undo a completed setup step by ID
undo STEP_ID:
  ...
```

If help is manual, update accordingly.
</details>

<verification>
- `just setup help` or `just setup` shows undo commands
- Help text is clear and concise
- Examples or descriptions help user understand when to use each command
</verification>

<done_criteria>
- Help text added/updated
- Test: just setup help shows undo and undo-list commands
</done_criteria>
</task>

</tasks>

<verification>
Full integration verification:

1. Setup a step:
   ```bash
   just setup brew  # Install something
   ```

2. List undoable steps:
   ```bash
   just setup undo-list  # Should show brew packages
   ```

3. Undo a step:
   ```bash
   just setup undo brew-bitwarden  # Uninstall Bitwarden
   ```

4. Verify state:
   ```bash
   cat $KYLDVS_PREFIX/state.json  # Status should be "undone"
   ```

5. Verify skip behavior:
   ```bash
   just setup all  # Should show "[undone]" for brew-bitwarden
   ```

6. Re-apply undone step:
   ```bash
   just setup brew  # Should re-install and mark complete
   ```

All commands should provide clear, helpful output at each stage.
</verification>

<success_criteria>
- Users can undo completed brew, brew-cask, and mac-defaults steps
- Users can see which steps are available to undo
- State correctly tracks "undone" status
- Undone steps are skipped in `just setup all` with clear messaging
- Individual step commands can re-apply undone steps
- All error messages are helpful and guide users to correct usage
- Help text documents the new commands
</success_criteria>

<output>
After completion, create `.planning/phases/04-undo-capability/04-02-SUMMARY.md` following the templates/summary.md structure.

Include in the summary:
- Commands added to justfile
- State functions added
- Example workflow showing undo/redo cycle
- Any deviations or issues encountered
- Next phase readiness assessment
</output>
